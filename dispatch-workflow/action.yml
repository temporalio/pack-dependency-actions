name: 'Dispatch Workflow'
description: 'Dispatch a workflow in a remote repository'
author: 'Temporal'

inputs:
  token:
    description: 'GitHub token with repo and workflow permissions for target repository'
    required: true
  repository:
    description: 'Target repository in owner/name format'
    required: true
  workflow:
    description: 'Workflow file name (e.g., update-dependencies.yml) or workflow ID'
    required: true
  ref:
    description: 'Git reference (branch, tag, or SHA) to run the workflow on'
    required: false
    default: 'main'
  inputs:
    description: 'JSON string of inputs to pass to the workflow'
    required: false
    default: '{}'
  add-commit-comment:
    description: 'Add a comment to the commit on push events'
    required: false
    default: 'false'
  commit-comment-template:
    description: 'Template for commit comment. Available variables: {repository}, {workflow}, {ref}'
    required: false
    default: 'üöÄ Triggered workflow `{workflow}` in {repository} on {ref}'
  log-output:
    description: 'Log the workflow dispatch result'
    required: false
    default: 'true'
  log-title:
    description: 'Title for the log output'
    required: false
    default: 'Workflow Dispatch'

outputs:
  dispatched:
    description: 'Whether the workflow was successfully dispatched'
    value: ${{ steps.dispatch.outputs.dispatched }}

runs:
  using: 'composite'
  steps:
    - name: Dispatch workflow
      id: dispatch
      shell: bash
      run: |
        echo "Dispatching workflow '${{ inputs.workflow }}' in ${{ inputs.repository }}..."

        # Use GitHub API directly for workflow dispatch
        # Note: --input expects the raw JSON to be passed, not -f which treats it as a string
        response=$(gh api \
          --method POST \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          /repos/${{ inputs.repository }}/actions/workflows/${{ inputs.workflow }}/dispatches \
          --input - <<< '{"ref": "${{ inputs.ref }}", "inputs": ${{ inputs.inputs }}}' 2>&1) || dispatch_failed=true

        # Check if dispatch was successful (API returns 204 No Content on success)
        if [ -z "$response" ] || [[ "$response" == "" ]]; then
          echo "‚úÖ Workflow dispatch request sent successfully"
          echo "dispatched=true" >> $GITHUB_OUTPUT
        else
          echo "Response: $response"
          # Check if it's an error
          if [ "$dispatch_failed" = "true" ] || echo "$response" | grep -q "error\|Error\|failed\|Failed"; then
            echo "::error::Failed to dispatch workflow"
            echo "dispatched=false" >> $GITHUB_OUTPUT
            exit 1
          else
            # Sometimes there's output but it's not an error
            echo "‚úÖ Workflow dispatch request sent"
            echo "dispatched=true" >> $GITHUB_OUTPUT
          fi
        fi
      env:
        GH_TOKEN: ${{ inputs.token }}

    - name: Log workflow dispatch
      if: inputs.log-output == 'true' && always()
      shell: bash
      run: |
        echo "## ${{ inputs.log-title }}"
        echo ""
        if [ "${{ steps.dispatch.outputs.dispatched }}" == "true" ]; then
          echo "‚úÖ Successfully dispatched workflow"
          echo "- **Repository:** ${{ inputs.repository }}"
          echo "- **Workflow:** ${{ inputs.workflow }}"
          echo "- **Reference:** ${{ inputs.ref }}"
          if [ '${{ inputs.inputs }}' != '{}' ] && [ -n '${{ inputs.inputs }}' ]; then
            echo "- **Inputs:** \`${{ inputs.inputs }}\`"
          fi
        else
          echo "‚ùå Failed to dispatch workflow"
          echo "- **Repository:** ${{ inputs.repository }}"
          echo "- **Workflow:** ${{ inputs.workflow }}"
        fi

    - name: Add comment to commit
      if: github.event_name == 'push' && steps.dispatch.outputs.dispatched == 'true' && inputs.add-commit-comment == 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
      run: |
        # Replace template variables
        COMMENT="${{ inputs.commit-comment-template }}"
        COMMENT="${COMMENT//'{repository}'/${{ inputs.repository }}}"
        COMMENT="${COMMENT//'{workflow}'/${{ inputs.workflow }}}"
        COMMENT="${COMMENT//'{ref}'/${{ inputs.ref }}}"

        # Create a comment on the commit
        gh api \
          --method POST \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          /repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
          -f body="$COMMENT"
