name: 'Version Sweep'
description: 'Check version consistency across all open PRs'
author: 'Your Organization'

inputs:
  file-path:
    description: 'Path to version file to check'
    required: false
    default: '.ui-sha'
  base-branch:
    description: 'Base branch to check PRs against'
    required: false
    default: 'main'
  labels-filter:
    description: 'Filter PRs by labels (comma-separated)'
    required: false
    default: ''
  max-parallel:
    description: 'Maximum parallel PR checks'
    required: false
    default: '5'
  token:
    description: 'GitHub token'
    required: false
    default: ${{ github.token }}

outputs:
  pr-count:
    description: 'Number of PRs checked'
    value: ${{ steps.get-prs.outputs.count }}
  pr-list:
    description: 'JSON array of PR numbers'
    value: ${{ steps.get-prs.outputs.list }}

runs:
  using: 'composite'
  steps:
    - name: Get open PRs
      id: get-prs
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
        INPUT_BASE_BRANCH: ${{ inputs.base-branch }}
        INPUT_LABELS_FILTER: ${{ inputs.labels-filter }}
      run: |
        echo "Fetching open PRs targeting $INPUT_BASE_BRANCH..."

        # Build label filter if provided
        LABEL_FILTER=""
        if [ -n "$INPUT_LABELS_FILTER" ]; then
          IFS=',' read -ra LABELS <<< "$INPUT_LABELS_FILTER"
          for label in "${LABELS[@]}"; do
            LABEL_FILTER="$LABEL_FILTER --label \"$label\""
          done
        fi
        
        # Get PR list
        PRS=$(gh pr list -R ${{ github.repository }} \
          --state open \
          --base $INPUT_BASE_BRANCH \
          $LABEL_FILTER \
          --json number \
          --jq '[.[].number]')
        
        PR_COUNT=$(echo "$PRS" | jq '. | length')
        echo "Found $PR_COUNT open PRs"
        
        echo "count=$PR_COUNT" >> $GITHUB_OUTPUT
        echo "list=$PRS" >> $GITHUB_OUTPUT
        
        # Create matrix for workflow dispatch
        if [ "$PR_COUNT" -gt 0 ]; then
          echo "matrix=$PRS" >> $GITHUB_OUTPUT
        else
          echo "matrix=[]" >> $GITHUB_OUTPUT
        fi